## YARA Rule Generator

PackGenome YARA rule generation process consists of two phases.

1. PackGenome extracts unpacking routine instructions from packed samples through pre-analysis, trace recording and bytes selection. 
2. PackGenome extracts packer-specific genes from similar instructions reused in unpacking routines and transforms them into YARA rules.

#### 0x1 LogGeneration.py

```
python LogGeneration.py
```

This script extracts unpacking routines from packed samples and generate trace files. LogGeneration.py will invoke PreAnalysis.py, Pintool and BytesAnalysis.py automatically according to the configuration file config/GenConfig.json.

The PreAnalysis.py script finds executable sections of PE files which are more likely to contain unpacking routine instructions. The result will be used as input for Pintool.

After pre-analysis, Pintool will record runtime information of programs and monitor the "written-then-executed" behaviors of instructions. The recorded trace information includes the memory address, the length of instruction bytes, the basic block's execution numbers, instruction bytes of basic blocks, and labels. 

The BytesAnalysis.py script analysis trace files generated by Pintool and finds unpacking routine instructions that are visible to static analysis (i.e., the first unpacking layer). The reason is that YARA and other signature-based detectors only search patterns from the programs staticaly. 

### 0x2 RuleGeneration.py

Command line argurments:

```sh
python RuleGeneration.py
```

- `-i` ï¼šGenerate YARA rules for inaccessible packers

This script will call SimilarityAnalysis.py to find similar instructions reused in unpack routines and generates YARA rules from them. Generated YARA rules will be stored in Generator/rules_dir folder.

### 0x3 GenConfig.json

[Generator/config/GenConfig.json](https://github.com/packgenome/PackGenome-Artifacts/blob/main/Generator/config/GenConfig.json) contains configuration options related to YARA rule generation. The key options excerpted from the configuration file are as follows.

```
"rules_dir": "rules_dir",              // Directory of generated rules
"inaccessibleTest": false,            // Generate YARA rules for inaccessible packers
"x64": false,                         // Instrumentation for x64 programs
"accessible_dir": "",                 // Samples packed by accessible packers for rule generateion
"accessible_yara": "",                // Name of generated rule for accessible packers
"inaccessible_dir": "",               // Samples packed by inaccessible packers for rule generateion
"inaccessible_yara": "",              // Name of generated rule for inaccessible packers
"accessible_packers": [],            // accessible packers for rules generation
"inaccessible_packers": [],          // inaccessible packers for rules generation
```

### 0x4 Artifact Evaluation

We provide [RGD dataset](https://github.com/packgenome/PackGenome-Artifacts/tree/main/Dataset/RGD) containing programs packed by 20 off-the-shelf packers and 5 inaccessible packers. AE reviewers can reproduce the YARA rule generation experiment of our paper.

- 20 off-the-shelf packers in RGD:

  ```
  UPX, Armadillo, MPRESS, PECompact, ASPack, VMProtect, FSG, Obsidium, Petite, kkrunchy, MEW, Themida, ACProtect, ZProtect, Winlicense, Enigma, MoleBox, WinUpack, expressor
  ```

- 5 inaccessible packers in RGD:

  ```
  NeoLite, BeRoEXEPacker, exe32pack, JDPack, packman
  ```

#### How to Execute

```shell
1. cd PackGenome
2. sh accrule_gen.sh
3. sh inaccrule_gen.sh
```

#### Expected Results

`accessible_rule.yar` and `inaccessible_rule.yar` will be generated in the `Generator/rules_dir` folder after executing the above commands. `accessible_rule.yar` contains YARA rules  generated for the 20 off-the-shelf packers. `inaccessible_rule.yar` contains YARA rules  generated for the 5 inaccessible packers. 

